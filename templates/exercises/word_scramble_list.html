{% extends "base.html" %}
{% load static %}

{% block title %}{{ page_title }} - Sami-Sa{% endblock %}

{% block content %}
{% csrf_token %}
<!-- Header -->
<header class="bg-gradient-to-r from-orange-500 to-amber-500 text-white shadow-lg">
    <div class="container mx-auto px-4 py-8">
        <a href="{% url 'exercises:exercise_dashboard' %}" class="text-orange-200 hover:text-white transition inline-flex items-center gap-2 mb-4">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
            </svg>
            Sp√§≈• na cviƒçenia
        </a>
        <div class="flex items-center gap-4">
            <span class="text-5xl">üîÄ</span>
            <div>
                <h1 class="text-3xl font-bold">{{ page_title }}</h1>
                <p class="mt-1 text-orange-100">{{ overview }}</p>
            </div>
        </div>
    </div>
</header>

<div class="container mx-auto px-4 py-8">
    <!-- Filter by lesson type -->
    <div class="mb-8 flex flex-wrap gap-3">
        <a href="{% url 'exercises:word_scramble_list' %}" 
           class="px-4 py-2 rounded-full text-sm font-medium {% if not request.GET.lesson_type %}bg-orange-500 text-white{% else %}bg-gray-200 text-gray-700 hover:bg-gray-300{% endif %} transition">
            V≈°etky
        </a>
        {% for lt, label in lesson_types %}
        <a href="?lesson_type={{ lt }}" 
           class="px-4 py-2 rounded-full text-sm font-medium {% if request.GET.lesson_type == lt %}bg-orange-500 text-white{% else %}bg-gray-200 text-gray-700 hover:bg-gray-300{% endif %} transition">
            {{ label }}
        </a>
        {% endfor %}
    </div>

    <!-- Instructions -->
    <div class="bg-orange-50 border border-orange-200 rounded-xl p-4 mb-8">
        <p class="text-orange-800 flex items-center gap-2">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
            </svg>
            <strong>N√°vod:</strong> Usporiadajte rozh√°dzan√© p√≠smen√° tak, aby vzniklo spr√°vne anglick√© slovo.
        </p>
    </div>

    <!-- Word Scramble Exercises -->
    {% regroup word by exercise as exercise_groups %}
    
    {% for group in exercise_groups %}
    <div class="bg-white rounded-xl shadow-md overflow-hidden border border-gray-100 mb-8">
        <div class="bg-gradient-to-r from-orange-500 to-amber-500 px-6 py-4">
            <h2 class="text-xl font-bold text-white">{{ group.grouper.title }}</h2>
            <p class="text-orange-100 text-sm mt-1">{{ group.grouper.question_text }}</p>
        </div>
        
        <div class="p-6">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                {% for scramble in group.list %}
                <div class="scramble-card bg-gray-50 rounded-xl p-6 border border-gray-200" 
                     data-original="{{ scramble.original_word|lower }}"
                     data-scramble-id="{{ scramble.id }}"
                     data-exercise-id="{{ group.grouper.id }}">
                    
                    <!-- Scrambled letters display -->
                    <div class="mb-4">
                        <p class="text-sm text-gray-500 mb-2">Rozh√°dzan√© p√≠smen√°:</p>
                        <div class="scrambled-letters flex flex-wrap gap-2 justify-center">
                            {% for letter in scramble.scrambled_word %}
                            <button class="letter-tile w-10 h-10 bg-white border-2 border-orange-300 rounded-lg text-xl font-bold text-orange-600 hover:bg-orange-100 hover:border-orange-400 transition-all duration-200 uppercase"
                                    onclick="addLetter(this, '{{ letter }}')">
                                {{ letter }}
                            </button>
                            {% endfor %}
                        </div>
                    </div>
                    
                    <!-- Answer area -->
                    <div class="mb-4">
                        <p class="text-sm text-gray-500 mb-2">Va≈°a odpoveƒè:</p>
                        <div class="answer-area min-h-12 bg-white border-2 border-dashed border-gray-300 rounded-lg p-2 flex flex-wrap gap-2 justify-center items-center">
                            <span class="text-gray-400 placeholder-text">Kliknite na p√≠smen√°...</span>
                        </div>
                    </div>
                    
                    <!-- Hint -->
                    {% if scramble.hint %}
                    <div class="mb-4 p-3 bg-amber-50 border border-amber-200 rounded-lg">
                        <p class="text-amber-800 text-sm">
                            <strong>üí° Pom√¥cka:</strong> {{ scramble.hint }}
                        </p>
                    </div>
                    {% endif %}
                    
                    <!-- Action buttons -->
                    <div class="flex gap-3">
                        <button onclick="checkScramble(this)" 
                                class="flex-1 px-4 py-2 bg-orange-500 text-white rounded-lg hover:bg-orange-600 transition font-medium check-btn">
                            Skontrolova≈•
                        </button>
                        <button onclick="resetScramble(this)" 
                                class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                            </svg>
                        </button>
                    </div>
                    
                    <!-- Feedback -->
                    <div class="feedback-area hidden mt-4 p-3 rounded-lg"></div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
    {% empty %}
    <div class="text-center py-12">
        <div class="text-6xl mb-4">üì≠</div>
        <h3 class="text-xl font-bold text-gray-800 mb-2">≈Ωiadne cviƒçenia</h3>
        <p class="text-gray-600">Pre tento filter nie s√∫ k dispoz√≠cii ≈æiadne rozh√°dzan√© slov√°.</p>
    </div>
    {% endfor %}

    <!-- Pagination -->
    {% if word.has_other_pages %}
    <nav class="mt-8 flex justify-center">
        <ul class="flex items-center gap-2">
            {% if word.has_previous %}
            <li>
                <a href="?page={{ word.previous_page_number }}{% if request.GET.lesson_type %}&lesson_type={{ request.GET.lesson_type }}{% endif %}" 
                   class="px-4 py-2 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 transition">
                    Predch√°dzaj√∫ca
                </a>
            </li>
            {% endif %}
            
            <li class="px-4 py-2 bg-orange-500 text-white rounded-lg">
                {{ word.number }} / {{ word.paginator.num_pages }}
            </li>
            
            {% if word.has_next %}
            <li>
                <a href="?page={{ word.next_page_number }}{% if request.GET.lesson_type %}&lesson_type={{ request.GET.lesson_type }}{% endif %}" 
                   class="px-4 py-2 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 transition">
                    ƒéal≈°ia
                </a>
            </li>
            {% endif %}
        </ul>
    </nav>
    {% endif %}
</div>

<script>
function addLetter(letterTile, letter) {
    const card = letterTile.closest('.scramble-card');
    const answerArea = card.querySelector('.answer-area');
    const placeholder = answerArea.querySelector('.placeholder-text');
    
    // Remove placeholder if present
    if (placeholder) {
        placeholder.remove();
    }
    
    // Hide the clicked letter tile
    letterTile.classList.add('invisible');
    
    // Create answer tile
    const answerTile = document.createElement('button');
    answerTile.className = 'answer-tile w-10 h-10 bg-orange-500 text-white rounded-lg text-xl font-bold hover:bg-orange-600 transition-all duration-200 uppercase';
    answerTile.textContent = letter;
    answerTile.dataset.originalTile = Array.from(letterTile.parentNode.children).indexOf(letterTile);
    answerTile.onclick = function() {
        removeLetter(this);
    };
    
    answerArea.appendChild(answerTile);
}

function removeLetter(answerTile) {
    const card = answerTile.closest('.scramble-card');
    const scrambledLetters = card.querySelector('.scrambled-letters');
    const answerArea = card.querySelector('.answer-area');
    
    // Show the original letter tile
    const originalIndex = parseInt(answerTile.dataset.originalTile);
    scrambledLetters.children[originalIndex].classList.remove('invisible');
    
    // Remove answer tile
    answerTile.remove();
    
    // Show placeholder if answer area is empty
    if (answerArea.children.length === 0) {
        const placeholder = document.createElement('span');
        placeholder.className = 'text-gray-400 placeholder-text';
        placeholder.textContent = 'Kliknite na p√≠smen√°...';
        answerArea.appendChild(placeholder);
    }
}

function checkScramble(button) {
    const card = button.closest('.scramble-card');
    const originalWord = card.dataset.original;
    const exerciseId = card.dataset.exerciseId;
    const answerArea = card.querySelector('.answer-area');
    const feedbackArea = card.querySelector('.feedback-area');
    
    // Get current answer
    const answerTiles = answerArea.querySelectorAll('.answer-tile');
    let currentAnswer = '';
    answerTiles.forEach(tile => {
        currentAnswer += tile.textContent.toLowerCase();
    });
    
    feedbackArea.classList.remove('hidden', 'bg-green-100', 'bg-red-100', 'bg-amber-100', 'text-green-800', 'text-red-800', 'text-amber-800');
    
    if (currentAnswer === originalWord) {
        feedbackArea.classList.add('bg-green-100', 'text-green-800');
        feedbackArea.innerHTML = '‚úÖ <strong>Spr√°vne!</strong> V√Ωborne, to je spr√°vna odpoveƒè!';
        
        // TRACK CORRECT ANSWER
        fetch('{% url "exercises:submit_answer" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]')?.value || ''
            },
            body: JSON.stringify({
                exercise_id: exerciseId,
                is_correct: true
            })
        }).catch(error => console.error('Error:', error));
        
        // Disable further interaction
        button.disabled = true;
        button.classList.add('opacity-50', 'cursor-not-allowed');
        answerTiles.forEach(tile => {
            tile.disabled = true;
            tile.classList.remove('hover:bg-orange-600');
        });
    } else if (currentAnswer.length === 0) {
        feedbackArea.classList.add('bg-amber-100', 'text-amber-800');
        feedbackArea.innerHTML = '‚ö†Ô∏è Najprv zostavte slovo kliknut√≠m na p√≠smen√°.';
    } else {
        feedbackArea.classList.add('bg-red-100', 'text-red-800');
        feedbackArea.innerHTML = '‚ùå <strong>Sk√∫ste znova.</strong> Toto nie je spr√°vna odpoveƒè.';
        
        // TRACK FAILED ATTEMPT
        fetch('{% url "exercises:submit_answer" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]')?.value || ''
            },
            body: JSON.stringify({
                exercise_id: exerciseId,
                is_correct: false
            })
        }).catch(error => console.error('Error:', error));
        
        // Add shake animation
        answerArea.classList.add('animate-shake');
        setTimeout(() => {
            answerArea.classList.remove('animate-shake');
        }, 500);
    }
}

function resetScramble(button) {
    const card = button.closest('.scramble-card');
    const scrambledLetters = card.querySelector('.scrambled-letters');
    const answerArea = card.querySelector('.answer-area');
    const feedbackArea = card.querySelector('.feedback-area');
    const checkBtn = card.querySelector('.check-btn');
    
    // Show all letter tiles
    scrambledLetters.querySelectorAll('.letter-tile').forEach(tile => {
        tile.classList.remove('invisible');
    });
    
    // Clear answer area
    answerArea.innerHTML = '<span class="text-gray-400 placeholder-text">Kliknite na p√≠smen√°...</span>';
    
    // Hide feedback
    feedbackArea.classList.add('hidden');
    
    // Re-enable check button
    checkBtn.disabled = false;
    checkBtn.classList.remove('opacity-50', 'cursor-not-allowed');
}
</script>

<style>
@keyframes shake {
    0%, 100% { transform: translateX(0); }
    25% { transform: translateX(-5px); }
    75% { transform: translateX(5px); }
}
.animate-shake {
    animation: shake 0.3s ease-in-out;
}
</style>
{% endblock %}